<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0>
        <style> body {padding: 0; margin: 0;} </style>
        <script language="javascript" type="text/javascript" src="../libraries/p5.min.js"></script>
        <script language="javascript" type="text/javascript" src="../libraries/addons/p5.sound.min.js"></script>
        <script language="javascript" type="text/javascript" src="../libraries/addons/p5.dom.min.js"></script>
        <script language="javascript" type="text/javascript" src="../libraries/opencv.js" ></script>
        <script src="utils.js" type="text/javascript"></script>
        <script src="sketch.js"></script>
    </head>
    <body>
        <div>
            <video id = "videoInput" hidden></video>
            <img id="imageSrc" src = "face.jpg" hidden>
            <div class="inputoutput">
                <canvas id="canvasFrame" hidden></canvas>
                <canvas id="canvasOutput" ></canvas>
            </div>
        </div>
    </body>
    <script type="text/javascript">

        let video = document.getElementById("videoInput"); // video is the id of video tag
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(function(stream) {
                video.srcObject = stream;
                video.play();
            })
            .catch(function(err) {
                console.log("An error occurred! " + err);
            });

        let canvasFrame = document.getElementById("canvasFrame"); // canvasFrame is the id of <canvas>
        let context = canvasFrame.getContext("2d");
        let src;
        let dst;
        let width;
        let height;
        let faces;
        let faceCascade;

        video.onloadeddata = function(){
            width = video.videoWidth;
            height = video.videoHeight;

            canvasFrame.width = width;
            canvasFrame.height = height;

            faces = new cv.RectVector();
            src = new cv.Mat(height, width, cv.CV_8UC4);
            dst = new cv.Mat(height, width, cv.CV_8UC1);

            const FPS = 30;
            function processVideo() {
                let begin = Date.now();
                context.drawImage(video, 0, 0, width, height);
                src.data.set(context.getImageData(0, 0, width, height).data);
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

                let faces = new cv.RectVector();

                let msize = new cv.Size(0, 0);
                faceCascade.detectMultiScale(dst, faces);

                for (let i = 0; i < faces.size(); ++i) {
                    let roiGray = dst.roi(faces.get(i));
                    let roiSrc = src.roi(faces.get(i));
                    let point1 = new cv.Point(faces.get(i).x, faces.get(i).y);
                    let point2 = new cv.Point(faces.get(i).x + faces.get(i).width, faces.get(i).y + faces.get(i).height);
                    cv.rectangle(src, point1, point2, [0, 255, 0, 255], 2);
                    roiGray.delete(); roiSrc.delete();
                }

                cv.imshow("canvasOutput", src); // canvasOutput is the id of another <canvas>;
                // schedule next one.
                let delay = 1000/FPS - (Date.now() - begin);
                setTimeout(processVideo, delay);
            }

            setTimeout(processVideo, 0);
        };

        let utils = new Utils('errorMessage');
        let faceCascadeFile = 'haarcascade_frontalface_default.xml';

        utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
            console.log('cascade ready to load.');
            loadCascade();
        });

        function loadCascade() {
            faceCascade = new cv.CascadeClassifier();

            if(faceCascade.load('haarcascade_frontalface_default.xml')){
                console.log("face cascade loaded");
            }else{
                console.log("face cascade not loaded");
            }
        }
    </script>
</html>
